/*! -- File: jquery.imageMap.js ( Input 0 ) -- */
!function(c){var d=function(a,b){this.el=c(a);this.preamble=c(a).find(".preamble");this.image=c(a).find("img.imagemap-image");this.dotSize=30;this.enabled=!0;this.render();this.options=b;this.options.showLabels=this.el.hasClass("showLabels");this.initDB(b.outline);this.answers=[];this.setListeners();this.scaler=new d.Scaler(this.image,{onChange:c.proxy(this.onScaleChanged,this)});this.redraw=DKI.func.debounce(c.proxy(this.drawZones,this),250,!1);this.setDropZones();return this};d.DEFAULTS={accessible:!0,
mapFillColour:"rgba(52,52,52,0.5)",mapStrokeColour:"rgb(52,52,52)",numberZones:!1,autoPosition:!0,enableDraggable:!0,strings:{previous:"Previous",next:"Next",finish:"Finish",correct:"Correct",incorrect:"Incorrect"}};d.constant=Object.freeze({screenReader:{visible:{tabindex:"1","aria-hidden":"false"},hidden:{tabindex:"-1","aria-hidden":"true"}}});d.prototype={initDB:function(a){this.db=function(){var a={},b={dragdrop_id:{}};return{store:function(b){a[b.id]=b},get:function(b){return a[b]},getByKey:function(a,
c){return b[a][c]},remove:function(b){delete a[item.id]},clear:function(){a={}},getLength:function(){return Object.keys(a).length}}}();var b=c.proxy(function(a){this.db.store(a);for(var c in a.elements)b(a.elements[c])},this);b(a)},render:function(){this.container=c('\x3cdiv class\x3d"dki-marker-container" style\x3d"position:absolute;z-index:1"\x3e\x3c/div\x3e').appendTo(this.image.parent());this.container.parent().css("position","relative")},initDrag:function(a,b){a.draggable({helper:function(a,
b,e,m){return c(this).find(".imagemap-label-dot").clone().css("margin","0")},revert:"invalid",containment:DKI.utility.getDragContainment(c(b.el),b.dotSize,b.dotSize),revertDuration:0,stack:this.el,scroll:"undefined"!=typeof settings?settings.responsive:c("html").hasClass("responsive"),zIndex:1E5,disabled:!1,start:function(){b.container.droppable("enable")},drag:function(a,b){DKI.utility.dragFix(b)},stop:function(a,c){c.helper.remove();b.container.droppable("disable")},cursorAt:{left:b.dotSize/2,top:b.dotSize/
2}})},setListeners:function(){var a=this;this.preamble.find("button").on("click",function(){a.preamble.addClass("hide")});if("undefined"!=typeof DKI&&"undefined"!=typeof DKI.ContentPage&&"undefined"!=typeof DKI.ContentPage.events)c(document).on(DKI.ContentPage.events.started,function(){setTimeout(function(){a.scaler.setScale()},10)});if(this.options.showLabels){var a=this,b=function(){c(".imagemap-label",a.el).length&&c(".imagemap-label",a.el).data("ui-draggable")||a.initDrag(c(".imagemap-label",
a.el),a);var b=DKI.utility.getScale();c(".imagemap-label",a.el).draggable("option","containment",DKI.utility.getDragContainment(c(a.el),a.dotSize,a.dotSize));c(".imagemap-label",a.el).draggable("option","cursorAt",{left:a.dotSize*b/2,top:a.dotSize*b/2})};c(window).on("resize",function(){a.options.enableDraggable&&b()});"undefined"!=typeof DKI&&"undefined"!=typeof DKI.ContentPage&&"undefined"!=typeof DKI.ContentPage.events&&(c(document).on(DKI.ContentPage.events.started,function(){setTimeout(function(){b()},
20)}),c(document).on(DKI.ContentPage.events.shown,function(){a.options.enableDraggable&&b()}),c(document).on(DKI.ContentPage.events.hidden,function(){a.options.enableDraggable&&b()}),c(document).on(DKI.ContentPage.events.imageMaps.refresh,function(){a.options.enableDraggable&&b()}),a.el.closest(".fancybox-content").length&&(a.el.closest(".fancybox-content").on("scroll",function(){a.options.enableDraggable&&b()}),c(window).on("scroll",function(){a.options.enableDraggable&&b()})));this.initDrag(c(".imagemap-label",
this.el),this);this.container.droppable({accept:".imagemap-label",disabled:!0,drop:function(b,c){b=c.helper.data("id");var e=DKI.utility.getScale();if(a.enabled){var m=a.container.offset();m.top/=e;m.left/=e;c.offset.top/=e;c.offset.left/=e;a.addAnswer({coords:[c.offset.left-m.left+a.dotSize*e/2,c.offset.top-m.top+a.dotSize*e/2],correctZoneId:b})}a.el.find(".imagemap-label-wrapper .imagemap-label[data-id\x3d"+b+"]").draggable("disable")}})}else this.container.on("click",function(b){a.enabled&&a.addAnswer({coords:[b.offsetX,
b.offsetY]})})},addAnswer:function(a){var b=this,c={correctZoneId:a.correctZoneId,helper:a.helper,idx:this.answers.length,imageMap:this,coords:a.coords,listeners:{destroy:function(){b.answers.splice(this.idx,1);b.options.showLabels&&b.el.find(".imagemap-label-wrapper .imagemap-label[data-id\x3d"+a.correctZoneId+"]").draggable("enable")}}};this.scaler.setScale();answer=this.options.showLabels?new d.LabelAnswer(c):new d.Answer(c);this.answers.push(answer)},enable:function(){c.each(this.answers,function(){this.enable()});
this.enabled=!0},disable:function(){c.each(this.answers,function(){this.disable()});this.enabled=!1},onScaleChanged:function(){c.each(this.answers,function(){this.reposition()});this.redraw()},setDropZones:function(){this.dropZones=this.options.outline.elements.map(function(a){var b=a.parameters.config.map;return{id:a.id,shape:b.shape,coords:b.coords,distractor:b.distractor||!1}})},reset:function(){for(;this.answers.length;)this.answers.pop().destroy();this.el.find(".imagemap-label").removeClass("correct incorrect");
c(".ui-draggable",this.el).draggable("enable");this.canvas&&(this.canvas.remove(),this.canvas=null);this.preamble.removeClass("hide");this.enable()},destroy:function(){this.scaler.destroy();this.container.remove();this.reset()},score:function(){var a=0,b=this.dropZones.filter(function(a){return!a.distractor}).length,h=Math.max(this.answers.length,b),g=this.answers.concat([]),e=this;c.each(this.dropZones,function(){for(var b=!1,c=this,d=function(g,e){e.correct=null===e.correctZoneId?!c.distractor:
!c.distractor&&c.id==e.correctZoneId;e.zone=c.id;a+=!b&&e.correct?1:0;h-=b?1:0;b=null===e.correctZoneId},f=g.length-1;0<=f;f--)switch(this.shape){case "poly":e.pointInPoly(e.scaler.parsePoly(this.coords),e.scaler.toScaled(g[f].coords))&&d(f,g[f]);break;case "circle":e.pointInCircle(e.scaler.parseCircle(this.coords).split(","),e.scaler.toScaled(g[f].coords))&&d(f,g[f]);break;case "rect":var l=e.scaler.parsePoly(this.coords);e.pointInPoly([[l[0][0],l[0][1]],[l[0][0],l[1][1]],[l[1][0],l[1][1]],[l[1][0],
l[0][1]]],e.scaler.toScaled(g[f].coords))&&d(f,g[f])}});return Math.max(a,0)/Math.max(h,b)*100},pointInPoly:function(a,b){var c=b[0];b=b[1];for(var g=!1,e=0,m=a.length-1;e<a.length;m=e++){var d=a[e][0],n=a[e][1],f=a[m][0],m=a[m][1];n>b!=m>b&&c<(f-d)*(b-n)/(m-n)+d&&(g=!g)}return g},pointInCircle:function(a,b){return Math.pow(b[0]-a[0],2)+Math.pow(b[1]-a[1],2)<=Math.pow(a[2],2)},drawZones:function(a){if(this.canvas){var b=this.canvas[0].getContext("2d");b.canvas.width=this.image.width();b.canvas.height=
this.image.height();this.canvas.width();this.canvas.height();b.clearRect(0,0,this.canvas.width,this.canvas.height);var h=this,g=a?this.getAnswersByZone():null;c.each(this.dropZones,function(a,d){var p=this;if(!g||g[this.id].length){var n="incorrect";p.distractor?(n="correct",c.each(h.answers,function(){this.zone==p.id&&(n="incorrect")})):c.each(h.answers,function(){this.zone==p.id&&this.correct&&(n="correct")});d="string"===typeof h.options.mapStrokeColour?h.options.mapStrokeColour:h.options.mapStrokeColour[n];
b.fillStyle="string"===typeof h.options.mapFillColour?h.options.mapFillColour:h.options.mapFillColour[n];b.lineWidth=3;b.strokeStyle=d;b.beginPath();switch(this.shape){case "poly":var f=h.scaler.parsePoly(this.coords),l=f[0],k=[[l[0],l[1]],[l[0],l[1]]];b.moveTo(l[0],l[1]);c.each(f,function(){b.lineTo(this[0],this[1]);this[0]<k[0][0]?k[0][0]=this[0]:this[0]>k[1][0]&&(k[1][0]=this[0]);this[1]<k[0][1]?k[0][1]=this[1]:this[1]>k[1][1]&&(k[1][1]=this[1])});b.closePath();break;case "rect":k=h.scaler.parsePoly(this.coords);
b.rect(k[0][0],k[0][1],k[1][0]-k[0][0],k[1][1]-k[0][1]);break;case "circle":f=h.scaler.parseCircle(this.coords).split(",").map(function(a){return parseInt(a,10)}),k=[[f[0]+f[2]*Math.cos(180),f[1]+f[2]*Math.sin(180)],[f[0]+f[2]*Math.cos(315),f[1]+f[2]*Math.sin(315)]],b.arc(f[0],f[1],f[2],0,2*Math.PI,!1)}b.fill();b.stroke();h.options.numberZones&&(b.fillStyle=d,b.beginPath(),d=[k[0][0]-4,k[0][1]-4],0>d[0]-8&&(d[0]=k[1][0]+4),0>d[1]-8&&(d[1]=k[1][1]+4),b.arc(d[0],d[1],8,0,2*Math.PI,!1),b.fill(),b.lineWidth=
1,b.strokeStyle="#FFF",b.stroke(),b.font="11px Open Sans",b.fillStyle="#fff",b.textAlign="center",b.textBaseline="middle",b.fillText(a+1,d[0],d[1]+1))}})}},getAnswersByZone:function(){var a=this.dropZones.reduce(function(a,c){a[c.id]=[];return a},{distractor:[]});c.each(this.answers,function(){a[this.zone||"distractor"].push(this)});return a},enterReview:function(a,b,d){var g=this;c(".ui-draggable",this.el).draggable("disable");c.each(this.answers,function(){this.showState()});this.canvas&&this.canvas.remove();
a&&(this.canvas=c('\x3ccanvas style\x3d"position:absolute; left:0; z-index:2;" /\x3e').appendTo(this.image.parent()),this.drawZones(b));d&&this.el.find(".imagemap-label:not(.correct):not(.incorrect)").each(function(){var a=g.db.get(c(this).data("id"));"undefined"!=typeof a.parameters.config.map.distractor&&a.parameters.config.map.distractor?c(this).addClass("correct"):c(this).addClass("incorrect")})},exitReview:function(){c(".ui-draggable",this.el).draggable("enable");c.each(this.answers,function(){this.hideState()});
this.inlineFeedback&&(this.inlineFeedback.destroy(),this.inlineFeedback=null);this.canvas.remove();this.canvas=null;this.el.find(".correct, .incorrect").removeClass("incorrect correct")},hasInlineFeedback:function(){var a=!1,b=this;c.each(this.getAnswersByZone(),function(c,d){if("distractor"!==c&&this.length&&""!==b.db.get(c).txt)return a=!0,!1});return a},showInlineFeedback:function(a,b){var h=[],g=this;c.each(this.getAnswersByZone(),function(a,c){"distractor"===a||!this.length||b&&""===g.db.get(a).txt||
h.push({answer:this[0],outline:g.db.get(a)})});this.inlineFeedback&&this.inlineFeedback.destroy();h.length&&(this.inlineFeedback=new d.Answer.Feedback(h,a),this.inlineFeedback.show())},export:function(){return this.answers.map(function(a){return a.export()})},import:function(a){var b=this;c.each(a,function(){b.addAnswer(this)})},resize:function(){this.scaler.setScale()},hasSelection:function(){return this.answers.length?!0:!1}};c.fn.ImageMap=function(a){var b=a,h=Array.prototype.slice.call(arguments,
1);return this.each(function(){var g=c(this),e=c(this).data("dki.ImageMap");options=c.extend(!0,{},d.DEFAULTS,"object"===typeof b&&b);if("string"===typeof a&&!e)return!1;e?"string"===typeof a&&(g=c(this).data("dki.ImageMap"))&&g[a]&&g[a].apply(c(this).data("dki.ImageMap"),h):g.data("dki.ImageMap",new d(this,options))})};c.fn.ImageMap.Constructor=d;d.Answer=function(a){DKI.apply(this,DKI.applyIf(a,{listeners:{destroy:function(){}},coords:[0,0],correctZoneId:null,helper:null,correct:!1},!0));this.dotSize=
30;this.enabled=!0;this.coords=this.coords.natural?this.coords.natural:this.imageMap.scaler.toNatural(this.coords);this.helper=a.helper;this.render();this.pointOffset={left:this.dotSize/2,top:this.dims.markerRect.height-(this.dims.markerRect.height-this.dims.pinRect.height)/2};this.setListeners();this.reposition();return this};d.Answer.prototype={render:function(){this.marker=c(d.Answer.templates.marker({}));this.imageMap.container.append(this.marker);this.dims={pinRect:this.marker[0].getBoundingClientRect(),
markerRect:this.marker.find(".marker")[0].getBoundingClientRect()}},setListeners:function(){var a=this,b=function(){a.marker.data("ui-draggable")&&a.marker.draggable("option","containment",DKI.utility.getDragContainment(c(a.imageMap.container),a.dotSize,a.dotSize))};c(window).on("resize",function(){a.marker.length&&a.marker.data("ui-draggable")||a.imageMap.initDrag(a.marker,a.imageMap);b()});a.marker.closest(".fancybox-content").length&&(a.marker.closest(".fancybox-content").on("scroll",b),c(window).on("scroll",
b));this.marker.draggable({containment:DKI.utility.getDragContainment(c(a.imageMap.container),a.dotSize,a.dotSize),distance:5,drag:function(a,b){DKI.utility.dragFix(b)},stop:function(b,c){a.coords=a.imageMap.scaler.toNatural([c.position.left+a.pointOffset.left,c.position.top+a.pointOffset.top])}});this.marker.on("click",function(){a.enabled&&a.destroy();return!1})},enable:function(){this.enabled=!0;this.marker.draggable("enable")},disable:function(){this.enabled=!1;this.marker.draggable("disable")},
reposition:function(){var a=this.imageMap.scaler.toScaled(this.coords);this.marker.css({left:a[0]-this.dims.pinRect.width/2,top:a[1]-(this.dims.markerRect.height-(this.dims.markerRect.height-this.dims.pinRect.height)/2)})},showState:function(){this.marker.find(".fa").removeClass("fa-times fa-check fa-circle incorrect correct").addClass(this.correct?"fa-check correct":"fa-times incorrect")},hideState:function(){this.marker.find(".fa").removeClass("fa-times fa-check incorrect correct").addClass("fa-circle")},
export:function(){return{coords:{natural:this.coords}}},showFeedback:function(a,b){this.marker.tooltipster({content:d.Answer.templates.feedback(a),position:"left",contentAsHTML:!0,minWidth:200,trigger:"custom",arrow:!0,theme:"tooltipster-capture",interactive:!0,zIndex:100030,functionReady:function(a,d){b(c(d.tooltip).find(".tooltipster-content"))}}).tooltipster("show")},hideFeedback:function(a){this.marker.hasClass("tooltipstered")&&this.marker.tooltipster("destroy");a&&a()},destroy:function(){this.hideFeedback();
this.listeners.destroy.call(this);this.marker.remove()}};d.LabelAnswer=function(a){DKI.apply(this,DKI.applyIf(a,{listeners:{destroy:function(){}},coords:[0,0],correctZoneId:null,correct:!1},!0));this.dotSize=30;this.correctZoneId=a.correctZoneId;this.label=c(".imagemap-label[data-id\x3d"+this.correctZoneId+"]");this.enabled=!0;this.coords=this.coords.natural?this.coords.natural:this.imageMap.scaler.toNatural(this.coords);this.render();this.pointOffset={left:this.dotSize/2,top:this.dotSize/2};this.setListeners();
this.reposition();return this};c.extend(d.LabelAnswer.prototype,d.Answer.prototype,{render:function(){this.marker=this.label.find(".imagemap-label-dot").clone();this.imageMap.container.append(this.marker);this.dims={pinRect:this.marker[0].getBoundingClientRect()}},reposition:function(){var a=this.imageMap.scaler.toScaled(this.coords);this.marker.css({left:a[0]-this.dims.pinRect.width/2,top:a[1]-this.dims.pinRect.height/2})},showState:function(){this.marker.removeClass("incorrect correct").addClass(this.correct?
"correct":"incorrect");this.label.removeClass("incorrect correct").addClass(this.correct?"correct":"incorrect")},hideState:function(){this.marker.removeClass("incorrect correct");this.label.removeClass("incorrect correct")},export:function(){return{coords:{natural:this.coords},correctZoneId:this.correctZoneId}},destroy:function(){this.hideState();d.Answer.prototype.destroy.call(this)}});d.Answer.templates={marker:Handlebars.compile("\x3cdiv class\x3d'markerContainer' style\x3d' position:absolute;top:{{y}}px;left:{{x}}px'\x3e\x3ci class\x3d'marker pin fa fa-circle'\x3e\x3c/i\x3e\x3c/div\x3e"),
feedback:Handlebars.compile("\x3cdiv class\x3d'testMeFeedback'\x3e\x3ch4\x3e\x3ci class\x3d'fa {{#if correct}}fa-check{{else}}fa-times{{/if}} label-circle'\x3e\x3c/i\x3e\x3cspan\x3e{{title}}\x3c/span\x3e\x3c/h4\x3e\x3cdiv class\x3d'header'\x3e{{idx}}. {{{elTitle}}}\x3c/div\x3e\x3cdiv\x3e{{{feedback}}}\x3c/div\x3e\x3cdiv class\x3d'controls flex justify-between'\x3e{{#each buttons}}\x3cdiv class\x3d'{{cls}}' style\x3d'float:none;'\x3e{{label}}\x3c/div\x3e{{/each}}\x3c/div\x3e\x3c/div\x3e")};d.Answer.Feedback=
function(a,b){this.hotspotList=a;this.index=0;this.current=this.hotspotList[this.index];if(b)c(this).on("done",c.proxy(b,this));return this};d.Answer.Feedback.prototype={next:function(a){if(this.index+a===this.hotspotList.length)this.hide(),this.index=0,this.current=this.hotspotList[this.index],c(this).trigger("done");else{var b=this.current,d=this;this.index=Math.max(this.index+a,0);this.current=this.hotspotList[this.index];b.answer.hideFeedback(function(){d.show()})}},setButtonHandlers:function(a){var b=
this;a.off("click").on("click",".next,.prev",function(){b.next(c(this).hasClass("next")?1:-1)})},show:function(){if(this.current&&this.current.answer){var a=this;this.current.answer.showFeedback({idx:this.index+1,elTitle:this.current.outline.title,feedback:this.current.outline.txt,title:this.current.answer.imageMap.options.strings[this.current.answer.correct?"correct":"incorrect"],correct:this.current.answer.correct,buttons:[0!==this.index?{label:this.current.answer.imageMap.options.strings.previous,
cls:"prev"}:{},{label:this.index>=this.hotspotList.length-1?this.current.answer.imageMap.options.strings.finish:this.current.answer.imageMap.options.strings.next,cls:"next"}]},function(b){a.setButtonHandlers(b)})}},hide:function(){this.current.answer.hideFeedback()},destroy:function(){this.hide()}};d.Scaler=function(a,b){this.image=a;this.options=DKI.applyIf(b,{onChange:function(){}});this.scale=[0,0];this.setScale(!0);var d=this;this.onWindowResize=DKI.func.debounce(function(){d.setScale.call(d)},
50,!1);c(window).on("resize",this.onWindowResize);return this};d.Scaler.prototype={setScale:function(a){var b=[this.image.width()/this.image[0].naturalWidth,this.image.height()/this.image[0].naturalHeight];if(b[0]!=this.scale[0]||b[1]!==this.scale[1])if(this.scale=b,!a)this.options.onChange()},toScaled:function(a){var b=this;return a.map(function(a,c){return a*b.scale[c]})},toNatural:function(a){var b=this;return a.map(function(a,c){return 1/b.scale[c]*a})},destroy:function(){c(window).off("resize",
this.onWindowResize)},parsePoly:function(a){var b=[],c=0,d=[];for(a=a.split(",");0<a.length;)d.push(a.shift()),c%2&&(b.push(this.toScaled(d)),d=[]),c+=1;return b},parseCircle:function(a){a=a.split(",");return this.toScaled(a.slice(0,2)).concat(a[2]*this.scale[0]).join(",")}}}(window.jQuery);